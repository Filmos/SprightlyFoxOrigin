〈toSpaceιmaterialsι{
  "Base": {
    'compactmachines:wall': {Stability: 0.7, Potential: 1.0},
    'minecraft:iron_block': {Stability: 1.8, Potential: 1.0},
    'tconstruct:pig_iron_block': {Stability: 2.1, Potential: 1.2, "Decay": 0.2},
    'tconstruct:slimesteel_block': {Stability: 2.3, Potential: 1.1},
    'minecraft:ancient_debris': {Stability: 6.0, Potential: 1.1},
    'byg:pendorite_block': {Stability: 12.0, Potential: 1.4},
    'byg:ametrine_block': {Stability: 10.0, Potential: 1.8},
    'minecraft:netherite_block': {Stability: 30.0, Potential: 1.8},
    'minecraft:coal_block': {Stability: 0.5, Potential: 1.1},
    'minecraft:obsidian': {Stability: 1.0, Potential: 1.2},
    'minecraft:lapis_block': {Stability: 0.4, Potential: 1.3},
    'minecraft:redstone_block': {Stability: 0.3, Potential: 1.6},
    'minecraft:quartz_block': {Stability: 0.6, Potential: 1.4},
    'minecraft:gold_block': {Stability: 1.2, Potential: 2.0},
    'tconstruct:rose_gold_block': {Stability: 0.2, Potential: 4.2},
    'materialis:fairy_block': {Stability: 1.4, Potential: 2.2},
    'minecraft:crying_obsidian': {Stability: 1.0, Potential: 2.8},
    'minecraft:emerald_block': {Stability: 1.8, Potential: 2.6},
    'minecraft:diamond_block': {Stability: 3.8, Potential: 2.2},
    'twilightforest:arctic_fur_block': {Stability: 1.5, Potential: 1.5},
    'twilightforest:ironwood_block': {Stability: 1.6, Potential: 1.3},
    'tconstruct:tinkers_bronze_block': {Stability: 1.3, Potential: 1.3},
    'tconstruct:copper_block': {Stability: 1.3, Potential: 1.2},
    'create:copper_block': {Stability: 1.3, Potential: 1.2},
    'create:brass_block': {Stability: 1.5, Potential: 1.1},
    'create:zinc_block': {Stability: 1.6, Potential: 1.0},
    'twilightforest:steeleaf_block': {Stability: 2.5, Potential: 1.2},
    'twilightforest:carminite_block': {Stability: 0.2, Potential: 6.0, "Dimensional Stability": -1.2},
    'tconstruct:hepatizon_block': {Stability: 3.4, Potential: 2.0},
    'tconstruct:cobalt_block': {Stability: 3.2, Potential: 2.4},
    'tconstruct:manyullyn_block': {Stability: 5.8, Potential: 2.7},
    'tconstruct:queens_slime_block': {Stability: 2.0, Potential: 2.5},
    'twilightforest:fiery_block': {Stability: 10.0, Potential: 4.2, "Heat": 2.4},
    'twilightforest:knightmetal_block': {Stability: 4.2, Potential: 2.6},
    'create:shadow_steel_casing': {Stability: 2.8, Potential: 1.6, "Dimensional Stability": -0.7},
    'create:refined_radiance_casing': {Stability: 2.6, Potential: 1.8, "Dimensional Stability": 0.7}
  }, 
  "Top": {
    'minecraft:daylight_detector': {Stability: 1.4, Potential: 0.0},
    'minecraft:sea_lantern': {Stability: 1.2, Potential: 0.3},
    'byg:blue_glowcane_block': {Stability: 0.9, Potential: 0.5},
    'byg:purple_glowcane_block': {Stability: 0.8, Potential: 0.6},
    'byg:pink_glowcane_block': {Stability: 0.6, Potential: 0.7},
    'byg:red_glowcane_block': {Stability: 0.5, Potential: 0.8},
    'minecraft:glowstone': {Stability: 0.4, Potential: 0.9},
    'minecraft:lantern': {Stability: 0.1, Potential: 0.7},
    'minecraft:soul_lantern': {Stability: 0.1, Potential: 1.1},
    'minecraft:end_rod': {Stability: 0.2, Potential: 1.5},
    'minecraft:enchanting_table': {Stability: 2.0, Potential: 0.8, "Spread": 0.3},
    'minecraft:beacon': {Stability: 1.7, Potential: 1.0, "Spread": 1.0},
    'minecraft:end_portal_frame': {Stability: 3.6, Potential: 2.0, "Dimensional Stability": 0.4},
    'minecraft:creeper_head': {Stability: 0.7, Potential: 1.1, "Decay": 0.2},
    'minecraft:zombie_head': {Stability: 0.7, Potential: 1.3, "Decay": 0.5},
    'minecraft:skeleton_skull': {Stability: 0.9, Potential: 1.1, "Decay": 0.5},
    'minecraft:wither_skeleton_skull': {Stability: 1.2, Potential: 1.8, "Decay": 1.6},
    'twilightforest:naga_trophy': {Stability: 1.3, Potential: 0.8},
    'twilightforest:lich_trophy': {Stability: 0.9, Potential: 1.2},
    'twilightforest:minoshroom_trophy': {Stability: 1.5, Potential: 1.4},
    'twilightforest:quest_ram_trophy': {Stability: 1.3, Potential: 1.6},
    'twilightforest:knight_phantom_trophy': {Stability: 1.8, Potential: 1.3, "Decay": -0.3},
    'twilightforest:yeti_trophy': {Stability: 1.2, Potential: 1.2, "Heat": -1.0},
    'twilightforest:snow_queen_trophy': {Stability: 1.4, Potential: 1.4, "Heat": -3.6},
    'twilightforest:hydra_trophy': {Stability: 3.4, Potential: 2.8, "Heat": 2.4},
    'twilightforest:ur_ghast_trophy': {Stability: -1.4, Potential: 4.2},
    'minecraft:dragon_head': {Stability: 2.4, Potential: 1.8, "Dimensional Stability": -0.3},
    'minecraft:campfire': {Stability: 0.5, Potential: 1.1, "Heat": 0.4},
    'minecraft:soul_campfire': {Stability: 0.7, Potential: 0.8, "Heat": 0.2},
    'byg:boric_campfire': {Stability: 0.4, Potential: 0.7, "Heat": 0.4, "Decay": -0.5},
    'byg:cryptic_campfire': {Stability: 0.6, Potential: 1.4, "Heat": 0.9}
  }
}〉


〈toFileι../out/client_scripts/monument_materials.jsι
let tooltip_cache = {}
let monument_materials = 〈readSpaceιmaterials〉

onEvent('item.tooltip', tooltip => {
  function relative(val, cond) {if(cond) return val; return (val>0?"+":"")+val}
  
  for(let type in monument_materials) {
    for(let m in monument_materials[type]) {
      mat = monument_materials[type][m]
  
      let tip = [
        Text.of("[Monument "+type+"]").darkPurple(),
        [Text.of("Stability: ").gray(), Text.of(relative(mat.Stability, type=="Base")).lightPurple()],
        [Text.of("Potential: ").gray(), Text.of(relative(mat.Potential, type=="Base")).lightPurple()]
      ]
  
      for(let spec in mat) {
        if(spec == "Stability" || spec == "Potential") continue
        tip.push([Text.of(spec+": "), Text.of(relative(mat[spec])).lightPurple()])
      }
  
      tooltip_cache[m] = tip
    }
  }
  
  tooltip.addAdvanced(Object.keys(tooltip_cache), (item, advanced, text) => {
    if(tooltip.isShift()) {
      text.addAll(0, tooltip_cache[item.id])
    } else {
      text.add(0, Text.of("[Monument Part]").darkGray())
    }
  })
})〉

〈toFileι../out/server_scripts/the_split.jsι
let monument_materials = 〈readSpaceιmaterials〉
let monument_shape = [
  [ 0,  0,  0, "Top" , 1],
  [ 0, -1,  0, "Base", 1.5],
  [ 0, -2,  0, "Base", 1.2],
  [ 0, -3,  0, "Base", 1.2],
  
  [ 0, -4,  0, "Base", 0.7],
  [-1, -4,  0, "Base", 0.7],
  [ 1, -4,  0, "Base", 0.7],
  [ 0, -4,  1, "Base", 0.7],
  [ 0, -4, -1, "Base", 0.7],
  
  [-2, -3,  0, "Base", 1.0],
  [ 2, -3,  0, "Base", 1.0],
  [ 0, -3,  2, "Base", 1.0],
  [ 0, -3, -2, "Base", 1.0],
  
  [-2, -2,  0, "Top", 0.7],
  [ 2, -2,  0, "Top", 0.7],
  [ 0, -2,  2, "Top", 0.7],
  [ 0, -2, -2, "Top", 0.7],
]

function loadNbtStorage(player) {
  let nbt = player.getFullNBT().ForgeCaps["origins:origin_component"].Powers
  let ret = {}
  for(let n in nbt) ret[nbt[n].Type] = nbt[n].Data
  return ret
}
function saveNbtStorage(player, data) {
  let dat = []
  for(let k in data) dat.push({Type: k, Data: data[k]})
  let nbt = player.getFullNBT()
  nbt.ForgeCaps["origins:origin_component"].Powers = dat
  player.setFullNBT(nbt)
}

function loadStoredTag(player, tag) {
  let ret = null
  let tags = player.getTags().forEach(t => {
    if(t.indexOf(tag+"-")==0) ret = t.split("-").slice(1).join(":")
  })
  return ret
}
function saveStoredTag(player, tag, value) {
  let toRemove = []
  let tags = player.getTags().forEach(t => {
    if(t.indexOf(tag+"-")==0) toRemove.push(t)
  })
  toRemove.forEach(t => player.server.runCommandSilent("/tag "+player.name+" remove "+t))
  player.server.runCommandSilent("/tag "+player.name+" add "+tag+"-"+value.replaceAll(":", "-"))
}


function getMonumentPos(player, type) {
  let dim = loadStoredTag(player, type+"PosD")
  let nbt = loadNbtStorage(player)
  let pref = "sprightly_fox:the_split_"+type+"Pos"
  return {x: nbt[pref+"X"], y: nbt[pref+"Y"], z: nbt[pref+"Z"], d: dim}
}
function setMonumentPos(player, type, value) {
  let nbt = loadNbtStorage(player)
  let pref = "sprightly_fox:the_split_"+type+"Pos"
  nbt[pref+"X"] = value.x
  nbt[pref+"Y"] = value.y
  nbt[pref+"Z"] = value.z
  saveNbtStorage(player, nbt)
  saveStoredTag(player, type+"PosD", value.d)
}


function displayMonumentStats(rootBlock, player, server, title) {
  let monStats = analyzeMonument(rootBlock, server, true)
  
  let message = '/tellraw '+player.name+' [{"text":"'+title+'","color":"dark_purple"},{"text":"\\nStability: ","color":"gray"},{"text":"'+Math.round(monStats.Stability*10)/10+'","color":"light_purple"},{"text":"\\nPotential: ","color":"gray"},{"text":"'+Math.round(monStats.Potential*10)/10+'","color":"light_purple"}'
  for(let spec in monStats) {
    if(spec == "Stability" || spec == "Potential" || spec == "missed") continue
    message += ',{"text":"\\n'+spec+': ","color":"white"},{"text":"'+Math.round(monStats[spec]*10)/10+'","color":"light_purple"}'
  }
  server.runCommandSilent(message+"]")
}
function animateMonument(server, pos, firstTime) {
  server.runCommandSilent(`/execute in ${pos.d} run particle minecraft:end_rod ${pos.x+0.5} ${pos.y} ${pos.z+0.5} 0 0 0 1 800`)
  if(firstTime) server.runCommandSilent(`/execute in ${pos.d} run particle minecraft:explosion ${pos.x+0.5} ${pos.y-2.5} ${pos.z+0.5} 0 0 0 1 10`)
  for(let dir of [[0, 1], [0, -1], [1, 0], [-1, 0]]) {
    for(let i = 0; i<20; i++) server.runCommandSilent(`/execute in ${pos.d} run particle minecraft:end_rod ${pos.x+dir[0]*i/10+0.5} ${pos.y-i/10+0.75} ${pos.z+dir[1]*i/10+0.5}`)
    if(firstTime) server.runCommandSilent(`/execute in ${pos.d} run particle minecraft:explosion ${pos.x+dir[0]*2+0.5} ${pos.y-1.5} ${pos.z+dir[1]*2+0.5}`)
  }
  
  if(firstTime) {
    server.runCommandSilent(`/execute in ${pos.d} run playsound minecraft:block.beacon.power_select block @a ${pos.x+0.5} ${pos.y+0.5} ${pos.z+0.5} 3 1.4`)
    server.runCommandSilent(`/execute in ${pos.d} run playsound minecraft:block.beacon.activate block @a ${pos.x+0.5} ${pos.y+0.5} ${pos.z+0.5} 3 0.8`)
  } else {
    server.runCommandSilent(`/execute in ${pos.d} run playsound minecraft:block.beacon.ambient block @a ${pos.x+0.5} ${pos.y+0.5} ${pos.z+0.5} 3 0.8`)
    server.runCommandSilent(`/execute in ${pos.d} run playsound minecraft:block.beacon.ambient block @a ${pos.x+0.5} ${pos.y+0.5} ${pos.z+0.5} 3 0.5`)
  }
}
function analyzeMonument(rootBlock, server, displayMissing) {
  let combined = {}
  for(let pos of monument_shape) { 
    let block = rootBlock.offset(pos[0], pos[1], pos[2])
    
    mat = monument_materials[pos[3]][block.getId()]
    if(!mat) {
      if(displayMissing) {
        server.runCommandSilent('/execute in '+block.getDimension()+' run particle alexsmobs:shocked '+(block.x-0.1)+' '+(block.y)+' '+(block.z-0.1))
        server.runCommandSilent('/execute in '+block.getDimension()+' run particle alexsmobs:shocked '+(block.x-0.1)+' '+(block.y)+' '+(block.z))
        server.runCommandSilent('/execute in '+block.getDimension()+' run particle alexsmobs:shocked '+(block.x-0.1)+' '+(block.y)+' '+(block.z+1.1))
        server.runCommandSilent('/execute in '+block.getDimension()+' run particle alexsmobs:shocked '+(block.x)+' '+(block.y)+' '+(block.z-0.1))
        server.runCommandSilent('/execute in '+block.getDimension()+' run particle alexsmobs:shocked '+(block.x)+' '+(block.y)+' '+(block.z+1.1))
        server.runCommandSilent('/execute in '+block.getDimension()+' run particle alexsmobs:shocked '+(block.x+1.1)+' '+(block.y)+' '+(block.z-0.1))
        server.runCommandSilent('/execute in '+block.getDimension()+' run particle alexsmobs:shocked '+(block.x+1.1)+' '+(block.y)+' '+(block.z))
        server.runCommandSilent('/execute in '+block.getDimension()+' run particle alexsmobs:shocked '+(block.x+1.1)+' '+(block.y)+' '+(block.z+1.1))
      }
      mat = {missed: 1}
    }
    for(let stat in mat) {
      if(!combined[stat]) combined[stat] = 0
      combined[stat] += mat[stat]*pos[4]
    }
  }
  return combined
}


// Teleportation trigger
events.listen('player.tick', function (event) {
  if (event.player.server && event.player.ticksExisted % 10 === 0) {
    if(!event.player.getPotionEffects().isActive("minecraft:levitation")
    || event.server.runCommandSilent("origin has power "+event.player.name+" sprightly_fox:the_split")==0) return
    
    event.server.scheduleInTicks(7, event.server, callback => {
      let pos = getMonumentPos(event.player, "Mon"); if(!pos.d) return
      let block = event.server.getWorld(pos.d); if(!block) return
      block = block.getBlock(pos.x, pos.y, pos.z)
      let monStats = analyzeMonument(block, event.server, false)
      
      event.server.runCommandSilent("/effect clear "+event.player.name+" minecraft:levitation")
      event.server.runCommandSilent(`/execute at ${event.player.name} run tag @e[distance=..0.5] add TheSplit.MidTeleport`)
      event.server.runCommandSilent(`/execute in ${pos.d} run tp @e[tag=TheSplit.MidTeleport] ${pos.x+0.5} ${pos.y+1.5} ${pos.z+0.5}`)
      event.server.runCommandSilent(`/tag @e[tag=TheSplit.MidTeleport] remove TheSplit.MidTeleport`)
      event.server.scheduleInTicks(3, event.server, callback => {animateMonument(event.server, pos, false)})
    })
    
  }
})


// Monument activation/stat check
onEvent('block.right_click', event => {
	if(event.item.getId() != 'rftoolsbase:infused_diamond') return
  if(event.server.runCommandSilent("origin has power "+event.player.name+" sprightly_fox:the_split")==0) return
  
  let missed = 0
  
  
  if(missed > 0) {
    event.server.runCommandSilent('/tellraw '+event.player.name+' [{"text":"Invalid structure!","color":"dark_red"}]')
  } else {
    let curMon = getMonumentPos(event.player, "Mon")
    let isActive = (curMon.d == event.block.getDimension() && curMon.x == event.block.x && curMon.y == event.block.y && curMon.z == event.block.z)
    
    displayMonumentStats(event.block, event.server, event.player, 'MONUMENT '+(isActive?"ACTIVE":"CREATED"))
    
    if(!isActive) {
      if(event.item.count == 1) event.server.runCommandSilent('/replaceitem entity '+event.player.name+' weapon.mainhand minecraft:air')
      else event.server.runCommandSilent('/replaceitem entity '+event.player.name+' weapon.mainhand rftoolsbase:infused_diamond '+(event.item.count-1))
      
      let newPos = {
        x: event.block.x,
        y: event.block.y,
        z: event.block.z,
        d: event.block.getDimension()
      }
      setMonumentPos(event.player, "Mon", newPos)
      animateMonument(event.server, newPos, true)
    }
  }
	
})〉